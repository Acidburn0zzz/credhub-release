#!/usr/bin/env bash

<%
dbusername = p('credhub.data_storage.username')
dbpassword = p('credhub.data_storage.password')
dbtype = p('credhub.data_storage.type')
dbhost = p('credhub.data_storage.host')
dbport = p('credhub.data_storage.port')
dbname = p('credhub.data_storage.database')
%>

set -eu

<% if dbtype == "postgres" %>
export PGUTILS_DIR=/var/vcap/packages/pg_utils_9.4
export PGPASSWORD="<%= dbpassword %>"
  <% if_p('credhub.data_storage.require_tls') do |require_tls|
    if require_tls %>
export PGSSLMODE="verify-full"
export PGSSLROOTCERT=/var/vcap/jobs/credhub/config/database_ca.pem
    <% end %>
  <% end %>

"${PGUTILS_DIR}/bin/pg_dump" \
  --user="<%= dbusername %>" \
  --host="<%= dbhost %>" \
  --port="<%= dbport %>" \
  --format="custom" \
  "<%= dbname %>" > "${BBR_ARTIFACT_DIRECTORY}/credhubdb_dump"

<% elsif dbtype == "mysql" %>
export MYSQLUTILS_DIR=/var/vcap/packages/mariadb_10.1.23
export MYSQL_PWD="<%= dbpassword %>"
"${MYSQLUTILS_DIR}/client/mysqldump" \
  -u "<%= dbusername %>" \
  -h "<%= dbhost %>" \
  -P "<%= dbport %>" \
  "<%= dbname %>" > "${BBR_ARTIFACT_DIRECTORY}/credhubdb_dump"

<% else %>
echo "Skipping backup, as database is not Postgres or Mysql"
<% end %>
