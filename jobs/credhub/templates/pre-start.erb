#!/bin/bash

set -eux

CERT_FILE=/var/vcap/jobs/credhub/config/cert.crt
PRIV_KEY_FILE=/var/vcap/jobs/credhub/config/priv.key
DATABASE_CA_CERT=/var/vcap/jobs/credhub/config/database_ca.crt

rm -f $CERT_FILE $PRIV_KEY_FILE $DATABASE_CA_CERT

<%
  begin
    p('credhub.tls.certificate')
    p('credhub.tls.private_key')
  rescue UnknownProperty
    raise "credhub.tls.certificate and credhub.tls.private_key must both be set."
  end
%>

cat > $CERT_FILE <<EOL
<%= p('credhub.tls.certificate') %>
EOL

cat > $PRIV_KEY_FILE <<EOL
<%= p('credhub.tls.private_key') %>
EOL

<% if_p('credhub.data_storage.tls_ca') do |tls_ca| %>

cat > $DATABASE_CA_CERT <<EOL
<%= tls_ca %>
EOL

<% end %>

/var/vcap/jobs/credhub/bin/install_crt.sh $CERT_FILE $PRIV_KEY_FILE $DATABASE_CA_CERT

<% if p('credhub.encryption.provider') == 'hsm' %>
cat > /var/vcap/jobs/credhub/config/hsm_cert.pem <<EOL
<%= p('credhub.encryption.hsm.certificate') %>
EOL

cat > /var/vcap/jobs/credhub/config/client_cert.pem <<EOL
<%= p('credhub.encryption.hsm.client_certificate') %>
EOL

cat > /var/vcap/jobs/credhub/config/client_key.pem <<EOL
<%= p('credhub.encryption.hsm.client_key') %>
EOL

ln -f -s /var/vcap/jobs/credhub/config/Chrystoki.conf /etc/Chrystoki.conf

export JAVA_HOME=/var/vcap/packages/openjdk_1.8.0/jdk

cp /var/vcap/packages/lunaclient/jsp/lib/LunaProvider.jar $JAVA_HOME/jre/lib/ext/
cp /var/vcap/packages/lunaclient/jsp/lib/libLunaAPI.so $JAVA_HOME/jre/lib/ext/
<% end %>